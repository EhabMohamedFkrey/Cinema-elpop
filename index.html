<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙŠÙ†Ù…Ø§ Ø§Ù„Ø¨ÙˆØ¨ | Cinema Elpop</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background-color: #121212; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: #1e1e1e; padding: 20px; border-radius: 12px; }
        input { width: 80%; padding: 12px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; }
        button { padding: 12px 25px; background: #e50914; color: white; border: none; cursor: pointer; font-weight: bold; }
        #videoArea { display: none; margin-top: 20px; }
        video { width: 100%; border-radius: 8px; background: #000; }
        .download-btn { display: inline-block; margin-top: 15px; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Ø³ÙŠÙ†Ù…Ø§ Ø§Ù„Ø¨ÙˆØ¨</h1>
        <input type="text" id="urlInput" placeholder="Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (Watch)...">
        <button onclick="fetchVideo()">Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¢Ù† ğŸš€</button>
        <p id="loading" style="display:none; color:#aaa;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ... (Ø§ØµØ¨Ø± Ø´ÙˆÙŠØ©)</p>

        <div id="videoArea">
            <video id="videoPlayer" controls playsinline></video>
            <br>
            <a id="downloadLink" class="download-btn" href="#" target="_blank">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>
        </div>
    </div>

    <script>
        async function fetchVideo() {
            const url = document.getElementById('urlInput').value;
            const loading = document.getElementById('loading');
            const videoArea = document.getElementById('videoArea');
            const video = document.getElementById('videoPlayer');
            const downloadBtn = document.getElementById('downloadLink');

            if (!url) return alert("Ø­Ø· Ø§Ù„Ø±Ø§Ø¨Ø·!");
            
            loading.style.display = 'block';
            videoArea.style.display = 'none';

            try {
                // 1. Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ
                const res = await fetch(`/get-video?url=${encodeURIComponent(url)}`);
                const data = await res.json();
                loading.style.display = 'none';

                if (data.success && data.stream_url) {
                    videoArea.style.display = 'block';
                    
                    // 2. Ù†Ø­ÙˆÙ„Ù‡ Ù„Ø±Ø§Ø¨Ø· "ÙƒÙˆØ¨Ø±ÙŠ" Ø¹Ø´Ø§Ù† ÙŠØ´ØªØºÙ„
                    // Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· m3u8 (Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±/Ø¬ÙˆØ¯Ø§Øª) Ø¨Ù†Ø´ØºÙ„Ù‡ Ø¹Ù„Ø·ÙˆÙ„
                    // Ù„Ùˆ mp4 (Ù…Ù„Ù) Ø¨Ù†Ø¹Ø¯ÙŠÙ‡ Ù…Ù† Ø§Ù„ÙƒÙˆØ¨Ø±ÙŠ
                    let finalUrl = data.stream_url;
                    
                    if (finalUrl.includes('.mp4')) {
                        finalUrl = `/proxy-video?url=${encodeURIComponent(finalUrl)}`;
                    }

                    downloadBtn.href = finalUrl; // Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‡ÙŠØ§Ø®Ø¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø´ØºØ§Ù„

                    if (Hls.isSupported() && data.stream_url.includes('.m3u8')) {
                        const hls = new Hls();
                        hls.loadSource(data.stream_url); // m3u8 Ø¹Ø§Ø¯Ø© Ù…Ø´ Ø¨ÙŠØ­ØªØ§Ø¬ ÙƒÙˆØ¨Ø±ÙŠ
                        hls.attachMedia(video);
                    } else {
                        video.src = finalUrl;
                    }
                    video.play();
                } else {
                    alert("Ù…Ø´ Ù„Ø§Ù‚ÙŠ ÙÙŠØ¯ÙŠÙˆ: " + data.message);
                }
            } catch (err) {
                loading.style.display = 'none';
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±");
            }
        }
    </script>
</body>
</html>
